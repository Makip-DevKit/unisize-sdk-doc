# unisizeSDK Readme（Objective‐C）

## ドキュメントのバージョン情報



- 2○/○○/○○ 初版

---

## 本ドキュメントについて

本ドキュメントでは Xcode Objective‐C で開発された iOS 向け EC アプリケーションに unisizeSDK を実装する方法について記載しています。

## unisizeSDK for iOS について

unisizeSDK for iOS は、Xcode Swift／Objective-C で開発された iOS 向け EC アプリケーションに対して、unisize のバーチャルフィッティング機能を提供する SDK です。  
導入することにより、iOS 向けの EC アプリケーションに対して 「unisize」、「unisize for KIDS」、「unisize for バッグ」のバナー表示、サイズレコメンド機能を提供します。  
また2025年2月にリリースした3D表示機能に対応しています。  

  
## unisize について

unisize は、オンラインでのショッピング体験を向上させるためのサービスです。ユーザーの体型と好みに基づいて最適なサイズを推薦し、EC サイト上でのサイズ選びの不安を解消します。  
ユーザーは簡単な質問に答えることで個別に最適なサイズ推薦を受けられ、返品率の削減にも貢献します。  
国内外の多くの EC サイトで利用されており、ユーザーフレンドリーなインターフェース、精度の高いサイズレコメンドを提供しています。 
  
## unisizeSDK の対応 OS、バージョン

・iOS 15、またはそれ以降

- iOS 13 以降をサポートするプロジェクトにも unisizeSDK を導入、ビルドできますが、iOS 13 および 14 では、一部の機能で十分な動作検証が行われていません。そのため、プロジェクトに導入する際は、`@available`属性や`if #available`文を用いて、iOS 15 以降の環境でのみ unisizeSDK を使用するように実装することを推奨します。

## 対象プロジェクト・言語

Xcode Swift／Objective-C で開発された iOS 用アプリケーションのプロジェクトに対して導入可能。

- 現在のバージョンでは Swift UI、ObjectiveC で開発されたプロジェクトでの導入には正式には対応しておりません。<br>（動作することは確認していますが、今後のバージョンで正式対応を予定しています。）
- 商品詳細画面、購入完了画面の全てが WkWebView で構成されている EC アプリの場合、unisizeSDK を使用することができません。Web 版 unisize をご利用ください。
- unisizeSDK では、商品詳細画面がネイティブ UI、購入完了画面が WkWebView で構成されている EC アプリでの unisizeSDK の導入に対応しています。<br>


Xcode Swift／Objective-C で開発された iOS 用アプリケーションのプロジェクトに対して導入可能。

- 商品詳細画面、購入完了画面の全てが WkWebView で構成されている EC アプリの場合、unisizeSDK を使用することができません。Web 版 unisize をご利用ください。
- unisizeSDK では、商品詳細画面がネイティブ UI、購入完了画面が WkWebView で構成されている EC アプリでの unisizeSDK の導入に対応しています。<br>
  コンバージョンの実装については、アプリの設計、構造に応じで、unisizeSDK の UnisizeCvTag Class を使用する方法と、Web 版 unisize の CV タグを利用する方法の 2 種類の実装方法があります。<br>
  実装方法など、詳しくは付属のドキュメント「unisize のコンバージョンの実装について」をご覧ください。
  
## バージョン履歴

### v1.◯

- Objective-C をサポートしました。実装方法については、Objective-C 用の Readme や SDK リファレンス、サンプルプロジェクトを参照ください。

### v1.5.5

- 【iOS】UnisizeBanner Class の 一部変数（delegate、parentView）が UnisizeBanner Class を null にしても破棄されない問題があったため、この部分を修正しました。
- 【iOS】UnisizeBanner Class に `close()` メソッドを追加しました。詳しくは SDK リファレンスをご覧ください。
- 【All】CI バナーのみを使用している一部クライアント様向けの対応を行いました。v1.5.5 より CI バナーのみの利用が可能になりました。
- 【All】2025年2月にリリースした3D表示機能に対応しました。対象商品でアンケート結果画面でシルエットの3D表示が可能になりました。
- 【iOS】アンケート画面の表示を微調整しました。
- 【All】内部処理の最適化
  
## v1.5.2 （Android 版のみ）

- 【Android】unisizeSDK で利用している Webview の SSL エラーハンドラの処理が、Google Play Console 上で警告が表示されることがあったため、この部分改良しました。
- 【Android】UnisizeBanner class の UnisizeBannerListener > fun didBeidChanged() の引数 `recommended_items` の名称を `recommendedItems` に変更しました。
- 【Android】内部処理の改善など

## v1.5.1 （Android 版のみ）

- 【Android】unisizeSDK を導入するアプリ側の設計、実装によって、 unisizeSDK v1.5 Android 版で unisize バナーをタップした際にアンケート画面が表示されないことがある問題を解決しました。<br>
  商品詳細画面で context から取得できる Activity が FragmentActivity、または FragmentActivity を継承した Class（AppCompatActivity など）ではない場合に、SDK 内で動的に FragmentActivity を生成して、アンケート画面を表示するように改良を加えています。<br>
  上記に伴い、AndroidManifest.xml へ下記の設定の追加が必要となります。

  ```xml

  <activity android:name="jp.co.makip.unisizesdk.UnisizeBanner$WebAppInterface$UnisizeDynamicFragmentActivity"
  android:exported="true" />

  ```
    
その他のバージョン情報は付属のドキュメント「バージョン履歴」をご覧ください。

## unisizeSDK for iOS 用サンプルコードについて

unisizeSDK for iOS を使用して unisize の各機能を利用するための簡単なサンプルアプリケーションのプロジェクトです。  
Swift／Objective-C で実装する場合の実装サンプルとして、また、機能テスト用としてご利用いただけます。

提供した unisizeSDK の下記ディレクトリ内に付属しています。

```
unisizeSDK > iOS > sample
```

## 導入手順

### zip ファイルから xcframework を導入

1. unisizeSDK ダウンロードサイトから、unisizeSDK for iOS の zip ファイルをダウンロード、解凍します。
2. Xcode を開き、unisizeSDK を追加する Objective-C プロジェクトを開きます。
3. プロジェクトの設定 →「General」タブを開き、「Frameworks, Libraries, and Embedded Content」セクションに移動します。
4. 「+」ボタンをクリックし、unisizeSDK.xcframework を選択してプロジェクトに追加します。
5. SDK を使用するソースファイルの先頭（import 文のある箇所）に「#import <UnisizeSDK/unisizeSDK.h>」を記述します。

### Swift Package Manager を使用して導入
  
※ 準備中（2025年春頃の対応を予定しています。）  
  
1. Xcode プロジェクトで、File > Swift Packages > Add Package Dependency... を選択します。
2. GitHub リポジトリの URL を入力して、パッケージをプロジェクトに追加します。

- Private リポジトリでの公開のため、Xcode の制限により、パッケージ導入画面上にパッケージの Readme やバージョン情報などの情報が表示されませんが、問題なく動作します。

## unisize SDK の実装

### unsizie バナー、unisize アンケート機能の実装手順（unisizeBanner Class）

下記に簡単な実装の手順を記載しています。
unisizeBanner Class で、他に使用できる関数や、参照可能な変数などは、付属のドキュメント「SDK リファレンス」も併せて参照ください。  
また、サンプルアプリのソースコードも併せてご確認ください。
  
1. EC アプリの商品詳細画面のストーリーボードのバナーを表示したい箇所に、バナー表示用の UIView を、1 つから 3 つ（TEXT バナー、EX バナー、CI バナー）配置します。

   - 2024年半ばの unisize アップデートに伴い、EX バナーの上か下に CI バナーが自動的に表示される機能が追加されています。  
     そのため、EX バナーの上か下に CI バナーが表示されている場合は、UnisizeBanner Classの 初期化時に CI バナー用の UIView を渡す必要はございません。CI バナーの表示位置を EX バナーとは離して配置したい場合にみご利用ください。
   - 必要に応じて AutoLayout の制約の設定も併せて行ってください。  
     （バナーのリサイズや非表示の際に画面のレイアウト調整を行う場合に必要となります。）
   - バナー表示用の UIView のサイズは任意のサイズで問題ありませんが、横幅はバナーが正常に表示できる範囲で配置してください。また、高さはデリゲート `- (void)unisizeBanner:(UnisizeBanner *)banner didResized:(NSString *)message width:(CGFloat)width height:(CGFloat)height viewType:(NSString *)viewType ` のタイミングで、配置した UIView に対して高さの調整を行うことで、適切なバナーサイズにリサイズできます。

1. Storyboard に配置したバナー表示用 UIView オブジェクトを、商品詳細画面の ViewController の .m ファイルにある ViewController Class に関連付けします。
   ```objectiveC
   @property (weak, nonatomic) IBOutlet UIView *exBannerRect;
   @property (weak, nonatomic) IBOutlet UIView *ciBannerRect;
   @property (weak, nonatomic) IBOutlet UILabel *bannerLabel;
   ```
1. 商品詳細画面の ViewController の .m ファイルの先頭に unisizeSDK のインポート文を追加します。

   ```objectiveC
   #import <UnisizeSDK/unisizeSDK.h>
   ```

1. 商品詳細画面の ViewController の .m ファイルの ViewController class に、unisizeBanner の変数を追加します。

   ```objectiveC
   @property (weak, nonatomic) IBOutlet UnisizeBanner *unisizeBanner;
   ```

1. ViewController Class の `- (void)viewDidLoad` 内に下記コードを追加して、unisizeBanner class の初期化とセットアップを行います。

   ```objectiveC
   self.unisizeBanner = [[UnisizeBanner alloc]
                     initWithTextBannerRect:self.textBannerRect
                     exBannerRect:self.exBannerRect
                     ciBannerRect:self.ciBannerRect
                     parentView:self
                     cid:cid ＜クライアントID＞,
                     itm:itm ＜アイテムID＞,
                     cuid:cuid ＜クライアントユーザーID＞,
                     lang:lang ＜表示言語＞,
                     enableWebViewLog:YES
                     enablePrintLog:YES
                     sendErrorLog:YES
                     delegate:self
       ];
   ```

   - TEXT バナー、EX バナー、CI バナーで使用する UnisizeBanner Class のインスタンスは必ず 1 つで使用してください。これは TEXT バナー、EX バナー、CI バナーで異なるインスタンスを使用すると、アンケート回答後のバナーの更新が対象のバナーでしか行えないためです。
   - 各パラメーターの詳細は、付属のドキュメント「SDK リファレンス」の「UnisizeBanner クラス > init() メソッド」を参照ください。
   - parentView には self を渡してください。
   - デリゲート（delegate）を利用する場合は、対象 Class がプロトコルに準拠していることを宣言してから delegate に self を渡してください。
   - cid、itm、cuid は、Web 版 unsize のバナータグで渡している値と同じ値を、String 型で渡す形になります。
   - customStyle を使うとバナーにカスタムスタイル（CSS）を適用できます。（v1.2 で対応）<br>なお、unisize バナーのバージョンアップ時に表示崩れや不具合の原因となる可能性があるため、バナーのカスタマイズは推奨していません。必要な場合に限り、アプリの UI との兼ね合いを考慮して使用してください。詳しくは本ドキュメントの「バナーのカスタムスタイル適用について」を参照ください。

1. UnisizeBanner class の完了時、バナーリサイズ時、エラー発生時などに、EC アプリケーション側で追加で処理を行う場合は、以下の実装を行います。
   バナーサイズ確定、バナー表示時に UI を調整したり、エラー発生時にユーザーに対して通知するといった場合に有用です。

   ```objectiveC
   // コンポーネントの処理完了時に実行される
   - (void)unisizeBanner:(UnisizeBanner *)banner didFinish:(NSString *)message {
       // ・・・ここに実行したいコードを実装します
   }

   // コンポーネントの処理失敗時に実行される
   - (void)unisizeBanner:(UnisizeBanner *)banner didFail:(UnisizeError *)errorObj {
       // ・・・ここに実行したいコードを実装します
   }

   // コンポーネントのリサイズ時に実行される
   - (void)unisizeBanner:(UnisizeBanner *)banner didResized:(NSString *)message width:(CGFloat)width height:(CGFloat)height viewType:(NSString *)viewType {
       // ・・・ここに実行したいコードを実装します
   }

   // WebView のバナー表示時に毎回通知（バナーのリロードが発生した場合も実行される）
   - (void)unisizeBanner:(UnisizeBanner *)banner didLoaded:(NSString *)message viewType:(NSString *)viewType {
       // ・・・ここに実行したいコードを実装します
   }

   // unisize 対象外商品の場合に呼び出される
   - (void)unisizeBanner:(UnisizeBanner *)banner didUnsupported:(NSString *)message {
       // ・・・ここに実行したいコードを実装します
   }

   // unisizeのbeidなどunisizeのCVタグに必要なデータの値更新時に実行される（v1.3追加）
   - (void)unisizeBanner:(UnisizeBanner *)banner didBeidChanged:(NSString *)beid recommendedItems:(NSString *)recommendedItems type:(NSString *)type {
       // ここに実行したいコードを実装します
   }
   ```

   - 各デリゲートのパラメーターについては、「SDK リファレンス > UnisizeBanner Class > デリゲート の実装」を参照ください。
   - `func unisizeBanner(_ banner: UnisizeBanner, didFail errorObj: UnisizeError)` で返される UnisizeError Class の内容については、「[SDK リファレンス > UnisizeError class](#unisizeerror-class)」を参照ください。
   - v1.3 より UnisizeBanner Class の Delegate に`didBeidChanged()`が追加されています。<br>購入画面 → 購入完了画面が WkWebView で構成されているアプリの場合で、WkWebView の購入完了画面の HTML に埋め込まれている unisize の CV タグを、アプリでもそのまま利用したい場合に対応できるようになりました。実装方法など、詳しくは付属のドキュメント「unisize のコンバージョンの実装について」をご覧ください。

#### AI 写真採寸を使用する場合

AI 写真採寸ではカメラ機能を使用するため、カメラの起動を許可する必要があります。Info.plist に下記を追加して下さい。
（カメラの撮影に関する処理は unisizeSDKに含まれています。）

##### Property List Key：

Privacy - Camera Usage Description（NSCameraUsageDescription）  
※ 値にはメッセージを設定します。

##### 参考：

[https://developer.apple.com/documentation/bundleresources/information_property_list/nscamerausagedescription](https://developer.apple.com/documentation/bundleresources/information_property_list/nscamerausagedescription)

## unisize の コンバージョンの実装について

unisize の CV タグ機能は、unisize の効果レポートやユーザーレポートなどの集計を行うために使用される機能です。  
ユーザーの購入完了時に unisize CV タグを介して送信されたデータは unisize サーバー上で集計され、弊社サービスの DX 上で、効果レポートやユーザーレポートとして確認いただけるようになります。  
アプリからの利用率など効果測定を行う上で、実装が必要な機能となります。

CV タグ機能はアプリの購入完了画面に実装します。  
実装方法など、詳しくは付属のドキュメント「unisize の コンバージョンの実装について」をご覧ください。

### お知らせ

バージョン v1.3 から、購入画面 → 購入完了画面が WkWebView で構成されているアプリの場合で、UnisizeCvTag Class を使用せずに、アプリの WkWebView の購入完了画面の HTML に埋め込まれている Web 版 unisize の CV タグをアプリでも利用したい場合に、対応できるようになりました。  
実装方法など、詳しくは付属のドキュメント「unisize の コンバージョンの実装について」をご覧ください。

## unisizeSDK で 使用している WKWebview のデバッグについて

1. お使いのパソコンと検証用の iPhone を USB で繋いだ状態で、Xcode で unisizeSDK を導入しているプロジェクトを起動します。
2. パソコン版の Safari を起動して「開発」メニューを表示すると、接続されている端末、unisizeSDK で使用している WKWebview が表示されます。
3. メニューから対象のを WKWebview を選択すると unisizeSDK 内部で利用している WKWebview のデバッグが可能になります。unisize バナータグ、CV タグに正しくパラメーターが渡っているかなどを検証できます。

- Safari の「Web デベロッパを有効にする」オプションを有効にする必要があります。iPhone とパソコンの接続時に接続許可を行う必要があります。

## 機能上の制限について

- 現在のバージョンの unisizeSDK では、Swift UI で開発された EC アプリケーションでの導入には未対応です。今後のバージョンでの対応を検討しています。
- 2025年2月末以降、unisize の仕様変更に伴い unisize のアンケート結果画面左上に表示される FaceChange バナーを削除した関係で、現在 unisizeSDK で FaceChangeは利用できなくなっています。あらかじめご了承ください。unisizeSDK の FaceChange については現在検討中となっています。

## バナーのカスタムスタイル適用について

v1.2 より unisize バナーのカスタムスタイル適用に対応しました。<br>
UnisizeBanner の初期化のタイミングで、customStyle に css を渡すことで可能となります。<br>
なお unisize では、バナーにカスタムスタイルを適用することで、バージョンアップ時に表示崩れや不具合の原因となる可能性があるなどの点から、バナーのカスタマイズを推奨していません。ブランドイメージや、アプリの UI との兼ね合いで、どうしてもバナーカスタマイズが必要な場合に限定してご利用ください。

### 実装例

<br>**Swift**<br>

```swift
    // バナーのカスタムスタイル
    NSString *customStyle = @" body { background: #ffffff !important;} .sdk_text_banner .unisize-av-content { font-size: 20px; background-color: #fff8dc !important; border: 2px solid #bdb76b !important; border-radius: 5px !important; } .sdk_ex_banner .unisize-nb-content { border: 2px solid #bdb76b !important; background-color: #fff8dc !important; border-radius: 5px; padding: 10px; }";

    // unisizeBanner の初期化とセットアップ
    self.unisizeBanner = [[UnisizeBanner alloc]
        initWithTextBannerRect: self.textBannerRect
        exBannerRect: self.exBannerRect
        ciBannerRect: self.ciBannerRect
        parentView: self
        cid: cid
        itm: itm
        cuid: cuid
        lang: lang
        enableWebViewLog: YES
        enablePrintLog: YES
        sendErrorLog: YES
        delegate: self
        customStyle: customStyle
    ];
```

- customStyle パラメーターにはバナーのカスタムスタイル（css）を渡します。
- customStyle パラメーターは TEXT バナー、EX バナー、CI バナー 共通で適用されます。必要に応じて適切なセレクタにスタイルを適用するようにしてください。
- バナーのセレクタを調べる場合は、iPhone と Mac を USB で接続してから、unisizeSDK を実装したアプリを Xcode 上で起動して、Safari の WKWebview デバック（開発ツール）を使用して HTML をご確認ください。（TEXT バナー、EX バナー、CI バナー、また unisize 導入時に選択したバナータイプによって HTML は異なります。 ）
- カスタムスタイルを適用することで、unisize バナーのバージョンアップ時に、表示崩れや不具合の問題が発生する可能性があります。

## エラーロギングについて

UnisizeSDK では、エラー発生時に品質向上のためエラーログを Unisize のエラーロギングサーバーへ送信する処理を備えています。収集したエラーログは今後の UnisizeSDK の品質改善や処理向上の目的のみに使用され、お客様の同意を得ずに第三者に提供することは、原則いたしません。

もしエラーログの送信を望まない場合は、インスタンス生成時に sendErrorLog に false を設定することで、ログの送信を止めることが可能です。

送信される情報は各 Class の didFail() で取得できる内容と同様の情報になります。

- purchaseid
- errorCode
- message
- viewType
- systemVer
- date
- lang
- device
- clientId
- system
- cuid
- itemId
- other
- logging_time
- logging_date

送信しない設定を行った場合、弊社側でのエラー発生時の状況把握ができない関係で、お問い合わせいただいても対応ができないケースが発生する可能性があることをあらかじめご了承ください。

## ライセンス（使用許諾）

付属のドキュメント「ライセンス」を参照ください。
